
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Travel Span — Touch-friendly</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  :root {
    --border:#e5e7eb;
    --muted:#6b7280;
    --bg:#ffffff;
    --card:#fafafa;
    --accent:#1f6feb;
    --danger:#e11d48;
  }
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); }
  body { height: 100dvh; }

  #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
  #sidebar { padding: 14px; border-right: 1px solid var(--border); overflow:auto; background: var(--bg); }
  #map { height: 100%; }

  h1 { font-size: 18px; margin: 0 0 8px; }
  .muted { color: var(--muted); font-size: 13px; }
  .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
  .row > input, .row > textarea { flex: 1; padding:12px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; }
  .btn { padding:10px 12px; border: 1px solid #d1d5db; border-radius: 10px; cursor: pointer; font-size:14px; }
  .btn.primary { background:var(--accent); color:white; border-color:var(--accent); }
  .btn.ghost { background:#f5f5f5; }
  .btn.block { width:100%; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; }
  .small { font-size: 13px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:12px; }
  .hint { font-size:12px; color:#444; }
  code.inline { background:#f3f4f6; padding:2px 6px; border-radius:6px; }

  .leaflet-control-toggle, .leaflet-control-info {
    background:#fff;
    border:1px solid var(--border);
    border-radius:8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow:hidden;
  }
  .leaflet-control-toggle a, .leaflet-control-info a {
    display:block; padding:8px 10px; text-decoration:none; color:#111827; font-weight:600;
  }

  #closeSidebar { display: none; position: sticky; top: -14px; margin: -14px -14px 8px -14px; padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border); background: linear-gradient(#fff, #fff); }
  #closeSidebar button { border: 1px solid var(--border); border-radius: 10px; background: #fff; padding: 8px 10px; font-size: 14px; }

  /* Suggest dropdown for geocoder */
  .suggest { position: relative; }
  .suggest-list { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border:1px solid var(--border); border-radius:10px; margin-top:4px; max-height: 220px; overflow: auto; z-index: 1100; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
  .suggest-item { padding:8px 10px; cursor: pointer; font-size: 13px; }
  .suggest-item:hover { background:#f3f4f6; }

  @media (max-width: 900px) {
    #app { grid-template-columns: 1fr; }
    #sidebar {
      position: fixed; z-index: 1000; top: 0; left: 0; height: 100dvh; width: 90vw; max-width: 420px;
      transform: translateX(-100%); transition: transform 0.25s ease; box-shadow: 0 6px 24px rgba(0,0,0,0.12); border-right: 1px solid var(--border);
    }
    #sidebar.open { transform: translateX(0); }
    #closeSidebar { display: block; }
    #overlay { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 900; display: none; }
    #overlay.show { display: block; }
    .row.stack { flex-direction: column; }
    .btn.block { width:100%; }
  }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div id="closeSidebar"><button id="closeBtn" aria-label="Close controls">✕ Close</button></div>
    <h1>My Travel Span</h1>
    <div class="muted">Enter or look up your northernmost, southernmost, easternmost, and westernmost places. We’ll draw the tightest bounding box and estimate how much of Earth it covers.</div>

    <div class="card">
      <div class="row suggest">
        <input id="nameN" placeholder="Northernmost place (e.g., Reykjavik)" />
        <button class="btn" data-lookup="N">Lookup</button>
        <div id="suggN" class="suggest-list" style="display:none;"></div>
      </div>
      <div class="row">
        <input id="latN" inputmode="decimal" placeholder="Latitude" />
        <input id="lonN" inputmode="decimal" placeholder="Longitude" />
      </div>

      <div class="row suggest">
        <input id="nameS" placeholder="Southernmost place (e.g., Cape Town)" />
        <button class="btn" data-lookup="S">Lookup</button>
        <div id="suggS" class="suggest-list" style="display:none;"></div>
      </div>
      <div class="row">
        <input id="latS" inputmode="decimal" placeholder="Latitude" />
        <input id="lonS" inputmode="decimal" placeholder="Longitude" />
      </div>

      <div class="row suggest">
        <input id="nameE" placeholder="Easternmost place (e.g., Tokyo)" />
        <button class="btn" data-lookup="E">Lookup</button>
        <div id="suggE" class="suggest-list" style="display:none;"></div>
      </div>
      <div class="row">
        <input id="latE" inputmode="decimal" placeholder="Latitude" />
        <input id="lonE" inputmode="decimal" placeholder="Longitude" />
      </div>

      <div class="row suggest">
        <input id="nameW" placeholder="Westernmost place (e.g., San Francisco)" />
        <button class="btn" data-lookup="W">Lookup</button>
        <div id="suggW" class="suggest-list" style="display:none;"></div>
      </div>
      <div class="row">
        <input id="latW" inputmode="decimal" placeholder="Latitude" />
        <input id="lonW" inputmode="decimal" placeholder="Longitude" />
      </div>

      <div class="row stack">
        <button class="btn primary block" id="plotBtn">Plot & Draw Box</button>
        <button class="btn ghost block" id="resetBtn">Reset</button>
      </div>
      <div class="hint">Antimeridian-aware: if your east/west points straddle the Pacific, we wrap across 180° for the tightest box.</div>
    </div>

    <div class="card small">
      <div><span class="pill">Output</span></div>
      <div id="bboxInfo" style="margin-top:6px;"></div>
      <div id="areaInfo" style="margin-top:6px;"></div>
    </div>

    <div class="card small">
      <div><span class="pill">CSV (optional)</span></div>
      <div class="hint" style="margin-top:6px;">Paste four lines (N,S,E,W): <code class="inline">name,lat,lon</code></div>
      <textarea id="csvInput" rows="5" style="width:100%; margin-top:6px;"></textarea>
      <div class="row" style="margin-top:6px;">
        <button class="btn block" id="loadCsvBtn">Load CSV</button>
      </div>
    </div>

    <div class="muted" style="margin-top:8px;">
      Built with Leaflet + Nominatim (OSM). All logic runs in your browser.
    </div>
  </div>
  <div id="map"></div>
</div>
<div id="overlay"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>
<script>
  const map = L.map('map', { worldCopyJump: true, zoomControl: true }).setView([20, 0], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> & <a href="https://carto.com/">Carto</a>'
  }).addTo(map);

  const markerLayer = L.layerGroup().addTo(map);
  let bboxLayer = L.layerGroup().addTo(map);
  let lastCoveragePopup = null;

  // Controls
  const ToggleControl = L.Control.extend({
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control leaflet-control-toggle');
      const link = L.DomUtil.create('a', '', container);
      link.href = '#'; link.title = 'Toggle controls'; link.textContent = 'Controls';
      L.DomEvent.on(link, 'click', (e)=>{
        e.preventDefault();
        if (window.matchMedia('(max-width: 900px)').matches) {
          const isOpen = document.getElementById('sidebar').classList.contains('open');
          toggleSidebar(!isOpen);
        }
      });
      return container;
    },
    onRemove: function(){}
  });
  map.addControl(new ToggleControl({ position: 'topleft' }));

  // Info control to re-open last coverage popup
  const InfoControl = L.Control.extend({
    onAdd: function() {
      const container = L.DomUtil.create('div', 'leaflet-control leaflet-control-info');
      const link = L.DomUtil.create('a', '', container);
      link.href = '#'; link.title = 'Show coverage info'; link.textContent = 'Info';
      L.DomEvent.on(link, 'click', (e)=>{
        e.preventDefault();
        if (lastCoveragePopup) {
          lastCoveragePopup.openOn(map);
        }
      });
      return container;
    },
    onRemove: function(){}
  });
  map.addControl(new InfoControl({ position: 'topleft' }));

  function toggleSidebar(open) {
    const side = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    if (open) { side.classList.add('open'); overlay.classList.add('show'); }
    else { side.classList.remove('open'); overlay.classList.remove('show'); }
    setTimeout(()=> map.invalidateSize(), 260);
  }
  document.getElementById('overlay').addEventListener('click', ()=> toggleSidebar(false));
  document.getElementById('closeBtn').addEventListener('click', ()=> toggleSidebar(false));
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggleSidebar(false); });

  // Helpers
  function parseNum(v) { const n = Number(v); return Number.isFinite(n) ? n : null; }
  function normalizeLon(lon) { return ((lon + 180) % 360 + 360) % 360 - 180; }
  function shortestLonSpan(lons) {
    const xs = lons.map(normalizeLon).sort((a,b)=>a-b);
    const ext = xs.concat(xs.map(x=>x+360));
    let bestSpan = Infinity, bestPair = [xs[0], xs[0]];
    let i=0, j=0, n=xs.length;
    while (i < n) {
      while (j < ext.length && ext[j] - ext[i] <= 360) j++;
      if (j - i >= n) {
        const span = ext[i+n-1] - ext[i];
        if (span < bestSpan) { bestSpan = span; bestPair = [ext[i], ext[i+n-1]]; }
        i++;
      } else { i++; }
    }
    return [normalizeLon(bestPair[0]), normalizeLon(bestPair[1])];
  }
  const toRad = (deg)=> deg * Math.PI / 180;
  function earthCoveragePercent(minLat, maxLat, minLon, maxLon){
    let lonSpan = maxLon - minLon;
    if (lonSpan < 0) lonSpan += 360;
    const dLambda = toRad(lonSpan);
    const sinPhi2 = Math.sin(toRad(maxLat));
    const sinPhi1 = Math.sin(toRad(minLat));
    const frac = (dLambda * (sinPhi2 - sinPhi1)) / (4 * Math.PI);
    return Math.max(0, Math.min(1, frac));
  }
  function km2ForFraction(frac){ return frac * 510_072_000; }
  const fmtPct = (p)=> p.toLocaleString(undefined, {maximumFractionDigits:2});
  const fmtKm2 = (k)=> k.toLocaleString(undefined, {maximumFractionDigits:0});
  const varDanger = ()=> getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#e11d48';

  // Geocoder (Nominatim)
  async function geocode(q) {
    if (!q || !q.trim()) return [];
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&q=${encodeURIComponent(q.trim())}`;
    const res = await fetch(url, { headers: { 'Accept-Language': navigator.language || 'en' } });
    if (!res.ok) return [];
    return await res.json();
  }
  function attachLookup(idPrefix) {
    const nameEl = document.getElementById('name'+idPrefix);
    const latEl = document.getElementById('lat'+idPrefix);
    const lonEl = document.getElementById('lon'+idPrefix);
    const suggEl = document.getElementById('sugg'+idPrefix);
    const btn = document.querySelector(`[data-lookup="${idPrefix}"]`);

    async function doLookup(){
      suggEl.style.display = 'none'; suggEl.innerHTML = '';
      const results = await geocode(nameEl.value);
      if (!results.length) { suggEl.style.display = 'none'; return; }
      results.forEach(r => {
        const item = document.createElement('div');
        item.className = 'suggest-item';
        item.textContent = r.display_name;
        item.addEventListener('click', ()=>{
          latEl.value = r.lat; lonEl.value = r.lon;
          suggEl.style.display = 'none'; suggEl.innerHTML = '';
        });
        suggEl.appendChild(item);
      });
      suggEl.style.display = 'block';
    }
    btn.addEventListener('click', (e)=>{ e.preventDefault(); doLookup(); });
    nameEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') { e.preventDefault(); doLookup(); } });
    document.addEventListener('click', (e)=>{ if (!suggEl.contains(e.target) && e.target !== nameEl && e.target !== btn) { suggEl.style.display='none'; } });
  }
  ['N','S','E','W'].forEach(attachLookup);

  // Helpers for popup positioning
  function normalizeLonSpan(minLon, maxLon){
    let span = maxLon - minLon;
    if (span < 0) span += 360;
    return span;
  }
  function midpointLon(minLon, maxLon){
    let span = normalizeLonSpan(minLon, maxLon);
    let mid = minLon + span/2;
    return normalizeLon(mid);
  }

  function draw(points) {
    markerLayer.clearLayers();
    bboxLayer.clearLayers();
    if (lastCoveragePopup) { map.closePopup(lastCoveragePopup); lastCoveragePopup = null; }

    points.forEach(p => {
      L.marker([p.lat, p.lon]).addTo(markerLayer)
        .bindPopup(`<b>${p.name}</b><br>${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}`);
      const lbl = L.tooltip({permanent:true, direction:'right', offset:[8,0]})
        .setContent(p.name).setLatLng([p.lat, p.lon]);
      markerLayer.addLayer(lbl);
    });

    const lats = points.map(p=>p.lat);
    const lons = points.map(p=>p.lon);
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const [minLonShort, maxLonShort] = shortestLonSpan(lons);

    let segments = [];
    if (minLonShort <= maxLonShort) segments.push([minLonShort, maxLonShort]);
    else segments.push([-180, maxLonShort], [minLonShort, 180]);

    const frac = earthCoveragePercent(minLat, maxLat, minLonShort, maxLonShort);
    const pct = frac * 100;
    const km2 = km2ForFraction(frac);
    const tooltipHtml = `<b>Bounding Box</b><br/>~ ${fmtPct(pct)}% of Earth<br/>≈ ${fmtKm2(km2)} km²`;

    const polys = [];
    segments.forEach(([lo1, lo2]) => {
      const poly = L.polygon([[minLat, lo1], [minLat, lo2], [maxLat, lo2], [maxLat, lo1]],
        {color:varDanger(), weight:3, fill:false, dashArray:'6 4'})
        .bindTooltip(tooltipHtml, {sticky:true});
      // On touch/click: open a popup with the same content
      poly.on('click', (e)=>{
        const center = [(minLat+maxLat)/2, midpointLon(lo1, lo2)];
        if (lastCoveragePopup) map.closePopup(lastCoveragePopup);
        lastCoveragePopup = L.popup({ autoClose:false, closeOnClick:true })
          .setLatLng(center)
          .setContent(tooltipHtml)
          .openOn(map);
      });
      poly.on('mouseover', ()=> poly.bringToFront());
      polys.push(poly.addTo(bboxLayer));
    });

    const all = L.featureGroup([...polys, markerLayer]);
    map.fitBounds(all.getBounds().pad(0.25));

    const info = document.getElementById('bboxInfo');
    let lonSpan = normalizeLonSpan(minLonShort, maxLonShort);
    info.innerHTML = `
      <div><b>Bounding Box</b></div>
      <div>Lat: <code class="inline">${minLat.toFixed(4)} to ${maxLat.toFixed(4)}</code></div>
      <div>Lon (shortest span): <code class="inline">${minLonShort.toFixed(4)} to ${maxLonShort.toFixed(4)}</code> (${lonSpan.toFixed(2)}°)</div>
    `;
    document.getElementById('areaInfo').innerHTML = `
      <div><b>Coverage</b></div>
      <div>~ <code class="inline">${fmtPct(pct)}%</code> of Earth's surface</div>
      <div class="muted">≈ ${fmtKm2(km2)} km²</div>
    `;

    // Also set/update lastCoveragePopup for Info button
    const centerAll = [(minLat+maxLat)/2, midpointLon(minLonShort, maxLonShort)];
    lastCoveragePopup = L.popup({ autoClose:false, closeOnClick:true })
      .setLatLng(centerAll)
      .setContent(tooltipHtml);
  }

  document.getElementById('plotBtn').addEventListener('click', ()=>{
    const pts = [
      {name: document.getElementById('nameN').value || 'North', lat: parseNum(document.getElementById('latN').value), lon: parseNum(document.getElementById('lonN').value)},
      {name: document.getElementById('nameS').value || 'South', lat: parseNum(document.getElementById('latS').value), lon: parseNum(document.getElementById('lonS').value)},
      {name: document.getElementById('nameE').value || 'East',  lat: parseNum(document.getElementById('latE'). value), lon: parseNum(document.getElementById('lonE').value)},
      {name: document.getElementById('nameW').value || 'West',  lat: parseNum(document.getElementById('latW').value), lon: parseNum(document.getElementById('lonW').value)},
    ];
    if (pts.some(p => p.lat === null || p.lon === null)) { alert('Please provide valid numbers for all latitudes and longitudes.'); return; }
    pts.forEach(p => { p.lat = Math.max(-90, Math.min(90, p.lat)); p.lon = normalizeLon(p.lon); });
    draw(pts);
    if (window.matchMedia('(max-width: 900px)').matches) toggleSidebar(false);
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    markerLayer.clearLayers();
    bboxLayer.clearLayers();
    map.setView([20,0], 2);
    document.getElementById('bboxInfo').innerHTML = '';
    document.getElementById('areaInfo').innerHTML = '';
    if (lastCoveragePopup) { map.closePopup(lastCoveragePopup); lastCoveragePopup = null; }
  });

  document.getElementById('loadCsvBtn').addEventListener('click', ()=>{
    const txt = document.getElementById('csvInput').value.trim();
    if (!txt) return;
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if (lines.length < 4) { alert('Need four lines: N, S, E, W. Each line: name,lat,lon'); return; }
    const mapIdToName = {N:'North', S:'South', E:'East', W:'West'};
    const pts = [];
    for (let i=0;i<4;i++){
      const parts = lines[i].split(',').map(s=>s.trim());
      if (parts.length < 3) { alert('Each line must be: name,lat,lon'); return; }
      const [name, latStr, lonStr] = parts;
      const lat = Number(latStr), lon = Number(lonStr);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) { alert('Lat/Lon must be numbers'); return; }
      pts.push({name: name || mapIdToName[['N','S','E','W'][i]], lat: Math.max(-90, Math.min(90, lat)), lon: normalizeLon(lon)});
    }
    draw(pts);
    if (window.matchMedia('(max-width: 900px)').matches) toggleSidebar(false);
  });

  // Demo
  const demo = [
    {name:'North (Reykjavik)', lat: 64.1466, lon: -21.9426},
    {name:'South (Cape Town)', lat: -33.9249, lon: 18.4241},
    {name:'East (Tokyo)', lat: 35.6762, lon: 139.6503},
    {name:'West (San Francisco)', lat: 37.7749, lon: -122.4194},
  ];
  draw(demo);

  window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 200));
</script>
</body>
</html>
